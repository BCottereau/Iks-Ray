<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<style>

.hexagon {
	fill: none;
	stroke: #000;
	stroke-width: 1px;
}
.hexagon:hover {
	stroke: #fff;
	stroke-width: 4px;
}
g text{
	fill: #000;
	stroke: none;
	stroke-width: 0px;
	font-size: 10px;
	font-family: arial;
}
body{text-align:center;}
p{font-family:arial;}

	</style>
	<script src="jquery-2.1.4.min.js"></script>
</head>
<body>
<p id="titre">titre</p>
<p id="collection">collection</p>
<p id="cote" style="font-size:14px; color:#aaa">cote</p>

<script src="d3.v3.min.js"></script>
<script src="d3.hexbin.min.js"></script>
<script>

//var margin = {top: 20, right: 20, bottom: 30, left: 40};
var infoTitre = document.getElementById("titre");
var infoColl = document.getElementById("collection");
var infoCote = document.getElementById("cote");

var width = 800;
var height = 740;
var radius = 64;
var etendu = 3;
var padding = 1;
          
var color = d3.scale.linear()
    .domain([0, 20])
    .range(["white", "steelblue"])
    .interpolate(d3.interpolateLab);

var hexbin = d3.hexbin()
    .size([width, height])
    .radius(radius);

//-------------------------------------------
var svg = d3.select("body").append("svg")
    .attr("width", width )
    .attr("height", height )
	.append("g");

svg.append("clipPath")
    .attr("id", "clip")
  .append("rect")
    .attr("class", "mesh")
    .attr("width", width)
    .attr("height", height);


	var grille = [];
	var livres = [];
		
	$.getJSON( "2.json", function( data ) {
		
		$.each( data, function( key, val ) {
			livres.push(val);
		});

	}).done(function() {
		
		//alert( livres[1].Titre );
		//création de la grille
		creaGrille();
		
		var exas = svg.append("g")
			.selectAll(".hexagon")
			.data(grille)
			.enter().append("g")
			.attr("id", function(d, i){
				return "g-" + i;
			})
			.attr("class", "hexagon");
			

		exas.append("path")
			.attr("d", hexbin.hexagon())
			.attr("transform", function(d) {
				return "translate(" + d.x + "," + d.y + ")"; 
			})
			.style("fill", function(d) {
				return d.bgcolor; 
			});
					
		/*exas.append("text")
			.attr("transform", function(d) {
				return "translate(" + d.x + "," + d.y + ")"; 
			})
			.attr("text-anchor","middle")
			.text(function(d, i){
				return d.titre;
			});*/
			
		exas.append("image")
			.attr("transform", function(d){
				return "translate(" + (d.x-(radius)+40) + "," + (d.y-(radius)+40) + ")"; 
			})
			.attr("width",(radius*0.8)+"px")
			.attr("height",(radius*0.8)+"px")
			.attr("xlink:href",function(d){
				return d.couverture;
				//return "livre.jpg";
			})
			.on("click",function(d){
				console.log(d.nom);
			});
			
		svg.append("image")
			.attr("width",(radius*2.38)+"px")
			.attr("height",(radius*2.38)+"px")
			.attr("id", "select")
			.attr("xlink:href", "select.png");
			
		var select = document.getElementById("select");
		select.setAttribute("display", "none");
		
		var groupe = document.querySelectorAll("g .hexagon");
		var nbrGroupe = groupe.length;
		for(i = 0; i < nbrGroupe ; i++)
		{
			groupe[i].addEventListener("click", function(e){
				//alert(e.target.parentNode.nodeName.toLowerCase());
				var id = Number(e.target.parentNode.id.substr(2));
				//alert( id );
				//alert(livres[id].dispos[0].Collection);
				//alert(grille[id].titre);
				
				infoColl.innerHTML = livres[id].dispos[0].Collection;
				infoColl.style.color = grille[id].bgcolor;
				infoCote.innerHTML = livres[id].dispos[0].Cote;
				infoTitre.innerHTML = grille[id].titre;
						
				select.setAttribute("transform", "translate(" + (grille[id].x - 74) + "," + (grille[id].y - 80) + ")");
				select.setAttribute("display", "block");
				
				
			}, false);
		}
	
	});



	
function creaGrille(){
	
	//création de la grille
	var id = 0,
		limit1 = 0,
		limit2 = etendu; //nombre d'hexagone autour du centre
		
		
	//alert(livres[1].Titre);
	
	var bgcolor = "#eee";
	var k = 0;
    for (var j = -etendu; j <= etendu; j++) {
        var i = limit1;
        while (i <= limit2) {

			if(livres[k].dispos[0].Collection == "Arts plastiques - SA"){bgcolor = "#8caf2c";}
			else if(livres[k].dispos[0].Collection == "Cinéma - SC"){bgcolor = "#2c2c84";}
			else if(livres[k].dispos[0].Collection == "Musique - SM"){bgcolor = "#9b212a";}
			else if(livres[k].dispos[0].Collection == "Photographie - SP"){bgcolor = "#43aed4";}
			else if(livres[k].dispos[0].Collection == "Arts du spectacle - ST"){bgcolor = "#d0177d";}
			else if(livres[k].dispos[0].Collection == "Urbanisme - T"){bgcolor = "#d3bf09";}
			else if(livres[k].dispos[0].Collection == "Géographie - X"){bgcolor = "#277038";}
			else if(livres[k].dispos[0].Collection == "Bandes dessinées"){bgcolor = "#43aed4";}
			else if(livres[k].dispos[0].Collection == "Sciences - L"){bgcolor = "#6b1756";}
			else if(livres[k].dispos[0].Collection == "Informatique Tech - N"){bgcolor = "#2c2c84";}
			else if(livres[k].dispos[0].Collection == "Philosophie - B"){bgcolor = "#674b37";}
			else if(livres[k].dispos[0].Collection == "Psychologie - C"){bgcolor = "#ca8330";}
			else{bgcolor = "#eee";}
				
        	grille.push({
                id: id++,
                coordinates: [i, j],
                lastSelected: 0,
                type: 'regular',
                idUti: -1,
                login: "",
                nbDoc: -1,
                role: "",
                resource: false,
                length:i*j,
                nom:"exa "+i+","+j,
				titre:"" + livres[k].Titre,
				bgcolor: "" + bgcolor,
				couverture: livres[k].couverture,
				etat: 0
                
            });		        				        		
            i++;
			k++;
        }
        if (j < 0) {
            limit1--;
        } else {
            limit2--;
        }
		
    }
	
	
	

	
    // http://goo.gl/8djhT
	var tilted = false, // true is horizontal alignment
		size = radius*2; // hexagon size
	
    var stepX = tilted ? size * 3 / 4 : Math.sqrt(3) * size / 2,
        stepY = tilted ? Math.sqrt(3) * size / 2 : size * 3 / 4,
        offset = size / Math.sqrt(3) * 3 / 4;
        
   grille.map(function(d, i) {
        var i = d.coordinates[0],
            j = d.coordinates[1],
            x = stepX * i + (!tilted ? offset * j : 0) + width / 2,
            y = stepY * j + (tilted ? offset * i : 0) + height / 2;
        d.centroid = [Math.round(x * 1e2) / 1e2, Math.round(y * 1e2) / 1e2];
        d.x = Math.round(x * 1e2) / 1e2;
        d.y = Math.round(y * 1e2) / 1e2;
        d.visible = !outbounds(x, y);
    });

}

function outbounds(x, y) {
    return x < padding || x > width - padding || y < padding || y > height - padding;
}


</script>
</body>
